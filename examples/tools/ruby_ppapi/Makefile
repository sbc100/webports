# Copyright (c) 2013 The Chromium Authors. All rights reserved.
# Use of this source code is governed by a BSD-style license that can be
# found in the LICENSE file.

VALID_TOOLCHAINS := glibc newlib pnacl
NACL_SDK_ROOT ?= $(abspath $(CURDIR)/../../..)
include $(NACL_SDK_ROOT)/tools/common.mk

TARGET = ruby
LIBS = ruby-static readline ncurses ppapi_simple nacl_io ppapi_cpp ppapi tar rt crypt
ifeq ($(TOOLCHAIN),glibc)
LIBS += util dl
NACL_LDFLAGS += -Wl,-export-dynamic
else
LIBS += c nosys glibc-compat
endif
SOURCES = main.c
INC_PATHS = $(NACLPORTS_INCLUDE)/ruby-2.0.0
ifeq ($(NACL_ARCH),x86_32)
INC_PATHS += $(NACLPORTS_INCLUDE)/ruby-2.0.0/i686-nacl
else
INC_PATHS += $(NACLPORTS_INCLUDE)/ruby-2.0.0/$(NACL_ARCH)-nacl
endif
INSTALL_DIR = $(NACL_PACKAGES_PUBLISH)/ruby/$(TOOLCHAIN)

ifeq ($(TOOLCHAIN),pnacl)
EXEEXT=.pexe
else
EXEEXT=.nexe
endif

# We want the nmf to contain all the .nexe we have previously
# built as well as the one currently being built, so we modify
# the list of executables that we pass to create_nmf.
EXECUTABLES += $(wildcard $(OUTDIR)/$(TARGET)_*$(EXEEXT))

# Build rules generated by macros from common.mk:

$(foreach src,$(SOURCES),$(eval $(call COMPILE_RULE,$(src),$(CFLAGS))))

ifeq ($(CONFIG),Release)
$(eval $(call LINK_RULE,$(TARGET)_unstripped,$(SOURCES),$(LIBS),$(DEPS)))
$(eval $(call STRIP_RULE,$(TARGET),$(TARGET)_unstripped))
else
$(eval $(call LINK_RULE,$(TARGET),$(SOURCES),$(LIBS),$(DEPS)))
endif

$(eval $(call NMF_RULE,$(TARGET),))

DATA_ARCHIVE = $(INSTALL_DIR)/rbdata-$(NACL_ARCH).tar
ASSETS = usr/bin/irb $(DATA_ARCHIVE) usr/lib/ruby/2.0.0
ifeq ($(TOOLCHAIN),glibc)
EXTRA_LIBS = lib/libz.so.1 lib/libreadline.so lib/libncurses.so.5
endif

CHROMEAPPS = $(NACL_SRC)/libraries/hterm/src/chromeapps
LIB_DOT = $(CHROMEAPPS)/libdot
NASSH = $(CHROMEAPPS)/nassh

install:
	mkdir -p $(INSTALL_DIR)
	tar -h -c -C ${NACLPORTS_PREFIX}/.. -f $(DATA_ARCHIVE) ${ASSETS}
	tar -h -r -C ${NACLPORTS_PREFIX} -f $(DATA_ARCHIVE) ${EXTRA_LIBS}
	LIBDOT_SEARCH_PATH=$(CHROMEAPPS) $(LIB_DOT)/bin/concat.sh -i $(NASSH)/concat/nassh_deps.concat -o $(INSTALL_DIR)/hterm.concat.js
	cp $(OUTDIR)/ruby*$(EXEEXT) $(INSTALL_DIR)
	cp $(OUTDIR)/ruby.nmf $(INSTALL_DIR)
	cp index.html $(INSTALL_DIR)
	cp ruby.js $(INSTALL_DIR)
ifeq ($(TOOLCHAIN),pnacl)
	sed -i 's/x-nacl/x-pnacl/g' $(INSTALL_DIR)/ruby.js
endif
ifeq ($(TOOLCHAIN),glibc)
	cp -r $(OUTDIR)/lib* $(INSTALL_DIR)
endif
